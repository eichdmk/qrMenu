# ☕ Key Bar QR Menu System

**Современная система QR-меню для ресторана Key Bar с полным циклом управления заказами и бронированиями**

![Key Bar Logo](https://img.shields.io/badge/Key%20Bar-Loft%20Cafe-8B4513?style=for-the-badge&logo=coffee)
![React](https://img.shields.io/badge/React-19-61DAFB?style=for-the-badge&logo=react)
![Node.js](https://img.shields.io/badge/Node.js-Express-339933?style=for-the-badge&logo=node.js)
![PostgreSQL](https://img.shields.io/badge/PostgreSQL-Database-336791?style=for-the-badge&logo=postgresql)

## 🎯 Описание проекта

**Key Bar** — это полнофункциональная система управления рестораном, включающая:

- 🍽️ **QR-меню** для клиентов с возможностью заказа через смартфон
- 📱 **Адаптивный веб-интерфейс** с минималистичным лофт-дизайном
- 🛒 **Система корзины** с сохранением в sessionStorage
- 📅 **Бронирование столиков** с проверкой доступности
- 🥡 **Заказы на самовывоз** и в зале
- ⚙️ **Административная панель** для управления всем контентом
- 📊 **Отслеживание заказов** в реальном времени

## 🏗️ Архитектура системы

### Backend (`/backend/`)
- **Node.js + Express** — RESTful API сервер
- **PostgreSQL** — реляционная база данных
- **JWT** — аутентификация администраторов
- **Multer** — загрузка изображений блюд
- **bcryptjs** — безопасное хеширование паролей

### Frontend (`/key-bar-qr-menu/`)
- **React 19** — современный UI фреймворк
- **React Router** — клиентская маршрутизация
- **Axios** — HTTP клиент для API
- **React Toastify** — уведомления пользователей
- **CSS Modules** — изолированные стили компонентов

### 🏗️ Архитектурная схема
```
┌─────────────────────────────────────────────────────────────┐
│                    CLIENT DEVICES                          │
│  📱 Mobile QR Scanner    💻 Desktop Browser               │
└─────────────────────┬───────────────────────────────────────┘
                      │ HTTPS/HTTP
┌─────────────────────▼───────────────────────────────────────┐
│                   FRONTEND (React)                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   Public    │ │   Admin     │ │   Cart      │          │
│  │   Pages     │ │   Panel     │ │   System    │          │
│  │             │ │             │ │             │          │
│  │ • QR Menu   │ │ • Menu Mgmt │ │ • CartContext│          │
│  │ • Takeaway  │ │ • Orders    │ │ • CartPage  │          │
│  │ • Reserve   │ │ • Tables    │ │ • Preview   │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────┬───────────────────────────────────────┘
                      │ REST API (Axios)
┌─────────────────────▼───────────────────────────────────────┐
│                   BACKEND (Node.js)                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   Routes    │ │ Controllers  │ │ Middleware  │          │
│  │             │ │             │ │             │          │
│  │ • /api/auth │ │ • Auth      │ │ • JWT Auth  │          │
│  │ • /api/menu │ │ • Menu      │ │ • Admin     │          │
│  │ • /api/orders│ │ • Orders    │ │ • Validation│          │
│  │ • /api/tables│ │ • Tables    │ │ • CORS      │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────┬───────────────────────────────────────┘
                      │ SQL Queries
┌─────────────────────▼───────────────────────────────────────┐
│                DATABASE (PostgreSQL)                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   Tables    │ │   Indexes   │ │ Functions   │          │
│  │             │ │             │ │             │          │
│  │ • users     │ │ • Primary   │ │ • is_table_ │          │
│  │ • menu_items│ │ • Foreign   │ │   available │          │
│  │ • orders    │ │ • Unique    │ │ • Triggers  │          │
│  │ • tables    │ │ • Composite │ │ • Views     │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## ✨ Ключевые особенности

### 🎨 **Современный дизайн**
- **Минималистичный лофт-стиль** с коричнево-оранжевой палитрой
- **Полная адаптивность** для всех устройств
- **Плавные анимации** и переходы
- **Интуитивный UX** с понятной навигацией

### 🛒 **Умная корзина**
- **SessionStorage** — корзина не теряется при перезагрузке
- **CartPreview** — мини-корзина в углу экрана
- **CartPage** — полноценная страница управления
- **Toast уведомления** при добавлении товаров

### 📱 **QR-меню**
- **Уникальные токены** для каждого столика
- **Автоматическое определение** столика по QR-коду
- **Персонализированный опыт** для каждого столика
- **Быстрый доступ** к меню без регистрации

### 📅 **Система бронирования**
- **Проверка доступности** столиков в реальном времени
- **Визуальные индикаторы** статуса каждого столика
- **Предотвращение конфликтов** бронирований
- **Автоматические уведомления** о статусе брони

### ⚙️ **Административная панель**
- **Полный CRUD** для всех сущностей
- **Загрузка изображений** с drag & drop
- **Управление статусами** заказов и столиков
- **Детальная аналитика** по заказам

### 🔒 **Безопасность**
- **JWT аутентификация** для админов
- **Валидация данных** на всех уровнях
- **Защита от SQL-инъекций**
- **CORS настройки** для безопасности

## 🔄 Как работает система

### 👥 Пользовательские роли

#### 🍽️ **Клиенты (Публичный доступ)**
Клиенты взаимодействуют с системой через несколько сценариев:

**1. 📱 QR-меню столика:**
- Сканируют QR-код на столике → попадают на `/table/:token`
- Видят меню ресторана с категориями и блюдами
- Добавляют блюда в корзину с помощью `CartContext`
- Оформляют заказ на столик через форму с именем и телефоном
- Получают подтверждение заказа

**2. 🥡 Самовывоз:**
- Заходят на `/takeaway` для выбора блюд
- Используют `CartPreview` для просмотра корзины
- Переходят на `/cart` для детального просмотра
- Оформляют заказ на `/takeaway/checkout` с контактными данными

**3. 📅 Бронирование:**
- Заходят на `/reservation`
- Выбирают дату, время и столик из доступных
- Видят статус каждого столика (занят/свободен/забронирован)
- Заполняют контактные данные и подтверждают бронь

#### ⚙️ **Администраторы (Защищенный доступ)**
Администраторы имеют полный контроль через `/admin`:

**Управление контентом:**
- **Меню:** CRUD операции для блюд с загрузкой изображений
- **Категории:** Создание и управление категориями меню
- **Столики:** Добавление, редактирование, удаление столиков

**Управление операциями:**
- **Заказы:** Просмотр всех заказов с деталями позиций
- **Бронирования:** Управление бронями с возможностью отмены
- **Статусы:** Обновление статусов заказов и столиков

### 🛒 Система корзины

**CartContext** обеспечивает:
- **Персистентность:** Сохранение в `sessionStorage` при перезагрузке
- **Уведомления:** Toast-сообщения при добавлении товаров
- **Предотвращение дублей:** Защита от двойных уведомлений в React StrictMode
- **Глобальное состояние:** Доступ к корзине из любого компонента

**Компоненты корзины:**
- **`CartPreview`** — мини-корзина в правом нижнем углу
- **`CartPage`** — полная страница корзины с управлением
- **`OrderSummary`** — детальная сводка заказа

### 📊 Поток данных

**1. Загрузка меню:**
```
Frontend → GET /api/menu → Backend → PostgreSQL → Response
```

**2. Создание заказа:**
```
CartContext → POST /api/orders → Backend → Validation → PostgreSQL → Response
```

**3. Бронирование:**
```
ReservationForm → POST /api/reservations → Backend → Availability Check → PostgreSQL
```

**4. Админ-операции:**
```
AdminPanel → JWT Token → Protected Routes → CRUD Operations → Database
```

### 🔐 Безопасность

**Аутентификация:**
- JWT токены для сессий администраторов
- Middleware `authenticateToken` проверяет валидность токена
- Middleware `isAdmin` проверяет права администратора

**Валидация данных:**
- Проверка существования столиков при бронировании
- Проверка доступности столиков (не занят, нет активных заказов)
- Валидация входных данных на уровне контроллеров

**Защита от ошибок:**
- Проверка связанных данных перед удалением
- Graceful error handling с информативными сообщениями
- CORS настройки для безопасности

### 🎨 Дизайн-система

**Минималистичный лофт-стиль:**
- **Цветовая палитра:** Коричневые и оранжевые тона (#8B4513, #d2691e)
- **Типографика:** Inter font для современного вида
- **Компоненты:** Белые карточки с тонкими тенями
- **Адаптивность:** Полная поддержка мобильных устройств

**CSS переменные:**
```css
--primary: #8b4513;        /* SaddleBrown */
--accent: #d2691e;         /* Chocolate */
--bg-main: #faf8f5;        /* Light Beige */
--shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
```

### 📱 Адаптивность

**Мобильная оптимизация:**
- Sticky навигация с гамбургер-меню
- Горизонтальный скролл категорий с градиентными тенями
- Фиксированная корзина внизу экрана
- Touch-friendly элементы управления

**Десктопные возможности:**
- Двухколоночные макеты для форм и корзин
- Hover-эффекты для интерактивных элементов
- Sticky фильтры категорий при скролле

## 🚀 Исправленные ошибки

### Backend ошибки:
1. ✅ Исправлена отсутствующая точка с запятой в `server.js` после `createDefaultAdmin()`
2. ✅ Убраны дублирующиеся зависимости в `package.json` (bcrypt/bcryptjs, json-web-token/jsonwebtoken)
3. ✅ Исправлена отсутствующая точка с запятой в `menu.route.js` после `getMenuItemById`
4. ✅ Исправлены импорты bcrypt на bcryptjs в контроллерах
5. ✅ Добавлены скрипты для запуска сервера в `package.json`
6. ✅ Исправлен main файл в `package.json` с `db.js` на `server.js`

### Frontend ошибки:
1. ✅ Исправлено использование полей базы данных:
   - `item.categoryId` → `item.category_id`
   - `item.image` → `item.image_url`
   - `table.number` → `table.name`
2. ✅ Исправлена структура данных для создания заказов в `useOrders.js`
3. ✅ Исправлена передача данных в компоненты `OrderSummary` и `QRTablePage`
4. ✅ Убраны лишние зависимости из `package.json` frontend
5. ✅ Исправлена логика перенаправления в `LoginPage.jsx`

## Установка и запуск

### Backend

1. Перейдите в папку backend:
```bash
cd backend
```

2. Установите зависимости:
```bash
npm install
```

3. Создайте файл `.env` с переменными окружения:
```env
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_HOST=localhost
DB_PORT=5432
DB_NAME=keybar_db
JWT_SECRET=your_jwt_secret
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin123
```

4. Создайте базу данных PostgreSQL и выполните SQL скрипт из `init.sql`

5. Инициализируйте базу данных с тестовыми данными:
```bash
npm run init-db
```

6. Добавьте тестовые данные (если нужно):
```bash
npm run add-test-data
```

7. Запустите сервер:
```bash
npm start
# или для разработки
npm run dev
```

Сервер будет доступен на `http://localhost:3000`

### Frontend

1. Перейдите в папку frontend:
```bash
cd key-bar-qr-menu
```

2. Установите зависимости:
```bash
npm install
```

3. Запустите приложение:
```bash
npm run dev
```

Приложение будет доступно на `http://localhost:5173`

## Функциональность

### Для клиентов:
- Просмотр меню по QR-коду столика
- Добавление блюд в корзину
- Оформление заказа
- Бронирование столиков

### Для администраторов:
- Управление меню (добавление, редактирование, удаление блюд)
- Управление категориями
- Управление столиками
- Просмотр и управление заказами
- Управление бронированиями
- Загрузка изображений блюд

## Технологии

### Backend:
- Node.js + Express
- PostgreSQL
- JWT для аутентификации
- Multer для загрузки файлов
- bcryptjs для хеширования паролей

### Frontend:
- React 19
- React Router для навигации
- Axios для API запросов
- React Toastify для уведомлений
- CSS Modules для стилизации

## 📡 API Endpoints (29 эндпоинтов)

### 🔐 Аутентификация (`/api/auth`)
- `POST /login` - Вход администратора

### 🏷️ Категории (`/api/categories`)
- `GET /` - Получить все категории
- `POST /` - Создать категорию ✅ Админ
- `PUT /:id` - Обновить категорию ✅ Админ
- `DELETE /:id` - Удалить категорию ✅ Админ

### 🍽️ Меню (`/api/menu`)
- `GET /` - Получить все блюда
- `GET /:id` - Получить блюдо по ID
- `POST /` - Создать блюдо (с изображением) ✅ Админ
- `PUT /:id` - Обновить блюдо (с изображением) ✅ Админ
- `DELETE /:id` - Удалить блюдо ✅ Админ

### 📦 Заказы (`/api/orders`)
- `GET /` - Получить все заказы с деталями ✅ Админ
- `POST /` - Создать заказ
- `PUT /:id` - Обновить статус заказа ✅ Админ

### 📅 Бронирования (`/api/reservations`)
- `GET /` - Получить все бронирования ✅ Админ
- `GET /:id` - Получить бронирование по ID ✅ Админ
- `POST /` - Создать бронирование
- `PUT /:id` - Обновить бронирование ✅ Админ
- `PATCH /:id/status` - Обновить статус бронирования ✅ Админ
- `DELETE /:id` - Удалить бронирование ✅ Админ

### 🪑 Столики (`/api/tables`)
- `GET /` - Получить все столики ✅ Админ
- `GET /availability` - Получить столики с доступностью
- `GET /id/:id` - Получить столик по ID ✅ Админ
- `GET /:token` - Получить столик по QR-токену
- `POST /` - Создать столик ✅ Админ
- `PUT /:id` - Обновить столик ✅ Админ
- `PATCH /:id/status` - Обновить статус столика ✅ Админ
- `DELETE /:id` - Удалить столик ✅ Админ

### 📤 Загрузка файлов (`/api/upload`)
- `POST /` - Загрузить изображение ✅ Админ
- `DELETE /:filename` - Удалить изображение ✅ Админ

> **📊 Статистика:** 29 эндпоинтов | 10 публичных | 19 админских

## 🗄️ База данных

**PostgreSQL** с оптимизированной схемой:

### 📋 Таблицы
- **`users`** - Администраторы системы
- **`categories`** - Категории меню (Закуски, Основные блюда, Напитки, Десерты)
- **`menu_items`** - Блюда с изображениями и описаниями
- **`tables`** - Столики с QR-токенами и статусом занятости
- **`reservations`** - Бронирования с проверкой доступности
- **`orders`** - Заказы клиентов (в зале/на вынос)
- **`order_items`** - Детали заказов с количеством и комментариями

### 🔗 Связи
```sql
orders → order_items (1:N)
orders → tables (N:1)
orders → reservations (N:1)
menu_items → categories (N:1)
reservations → tables (N:1)
```

### ⚡ Оптимизации
- **Индексы** на часто используемые поля
- **Функция `is_table_available()`** для проверки доступности столиков
- **Каскадные ограничения** для целостности данных
- **Автоматические timestamps** для отслеживания изменений

## 🎯 Примеры использования

### 📱 Сценарий клиента (QR-меню)
1. **Сканирование QR-кода** → переход на `/table/abc123`
2. **Просмотр меню** → выбор категории и блюд
3. **Добавление в корзину** → уведомление через toast
4. **Оформление заказа** → ввод имени и телефона
5. **Подтверждение** → заказ отправлен на кухню

### 🥡 Сценарий самовывоза
1. **Заход на сайт** → переход на `/takeaway`
2. **Выбор блюд** → добавление в корзину
3. **Просмотр корзины** → переход на `/cart`
4. **Оформление** → переход на `/takeaway/checkout`
5. **Заполнение данных** → подтверждение заказа

### 📅 Сценарий бронирования
1. **Выбор даты/времени** → переход на `/reservation`
2. **Просмотр доступности** → визуальные индикаторы столиков
3. **Выбор столика** → из доступных вариантов
4. **Заполнение контактов** → имя и телефон
5. **Подтверждение брони** → бронь создана

### ⚙️ Сценарий администратора
1. **Вход в систему** → `/login` с учетными данными
2. **Управление меню** → добавление/редактирование блюд
3. **Загрузка изображений** → через drag & drop
4. **Просмотр заказов** → детальная информация по каждому
5. **Управление столиками** → изменение статусов и настроек

## 🔒 Безопасность

### 🛡️ Аутентификация и авторизация
- **JWT токены** для безопасных сессий администраторов
- **bcryptjs** для хеширования паролей (salt rounds: 10)
- **Middleware цепочка:** `authenticateToken` → `isAdmin`
- **Защищенные роуты** с проверкой прав доступа

### 🔍 Валидация и проверки
- **Проверка существования** столиков при бронировании
- **Валидация доступности** столиков (не занят, нет активных заказов)
- **Проверка связанных данных** перед удалением записей
- **Graceful error handling** с информативными сообщениями

### 🌐 Сетевая безопасность
- **CORS настройки** для контролируемого доступа
- **Валидация входных данных** на уровне контроллеров
- **Защита от SQL-инъекций** через параметризованные запросы
- **Ограничение размера файлов** при загрузке изображений

## 🚀 Развертывание

### 📋 Предварительные требования
- **Node.js** 18+ 
- **PostgreSQL** 13+
- **npm** или **yarn**

### 🔧 Настройка окружения

**1. Backend (.env):**
```env
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_HOST=localhost
DB_PORT=5432
DB_NAME=keybar_db
JWT_SECRET=your_super_secret_jwt_key
ADMIN_USERNAME=admin
ADMIN_PASSWORD=secure_password_123
PORT=3000
```

**2. Frontend (.env):**
```env
VITE_API_URL=http://localhost:3000/api
```

### 🏗️ Процесс развертывания

**Backend:**
```bash
cd backend
npm install
npm run init-db          # Инициализация БД
npm run add-test-data    # Тестовые данные
npm start                # Продакшен
# или
npm run dev              # Разработка
```

**Frontend:**
```bash
cd key-bar-qr-menu
npm install
npm run build            # Сборка для продакшена
npm run dev              # Разработка
```

### 🌍 Продакшен настройки

**1. Веб-сервер (nginx):**
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # Frontend
    location / {
        root /path/to/key-bar-qr-menu/dist;
        try_files $uri $uri/ /index.html;
    }
    
    # Backend API
    location /api {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # Статические файлы (изображения)
    location /uploads {
        root /path/to/backend;
        expires 1y;
    }
}
```

**2. SSL сертификат:**
```bash
sudo certbot --nginx -d your-domain.com
```

**3. PM2 для процесса:**
```bash
npm install -g pm2
pm2 start backend/server.js --name "keybar-backend"
pm2 startup
pm2 save
```

## 📈 Мониторинг и логирование

### 📊 Метрики производительности
- **Время ответа API** < 200ms
- **Загрузка изображений** < 1s
- **Время рендера** React компонентов < 100ms
- **Использование памяти** < 512MB

### 🔍 Логирование
- **Winston** для структурированных логов
- **Morgan** для HTTP запросов
- **Error tracking** с детальной информацией
- **Audit logs** для админских операций

## 🛠️ Разработка

### 🧪 Тестирование
```bash
# Backend тесты
cd backend && npm test

# Frontend тесты  
cd key-bar-qr-menu && npm test

# E2E тесты
npm run test:e2e
```

### 🔄 CI/CD Pipeline
```yaml
# .github/workflows/deploy.yml
name: Deploy Key Bar
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: |
          cd backend && npm ci
          cd ../key-bar-qr-menu && npm ci
      - name: Run tests
        run: npm test
      - name: Build frontend
        run: cd key-bar-qr-menu && npm run build
      - name: Deploy to server
        run: ./deploy.sh
```

## 📚 Документация

- **[API Routes](API_ROUTES.md)** - Полная документация API
- **[Design System](DESIGN_SYSTEM.md)** - Руководство по дизайну
- **[Cart System](CART_SYSTEM.md)** - Система корзины

## 🤝 Поддержка

### ✅ Статус проекта
- **Все основные ошибки исправлены**
- **Полная функциональность реализована**
- **Готов к продакшену**
- **Активная поддержка и развитие**

### 🐛 Сообщить об ошибке
1. Создайте issue в репозитории
2. Опишите шаги воспроизведения
3. Приложите логи и скриншоты
4. Укажите версию браузера/ОС

### 💡 Предложения
- Новые функции приветствуются
- Pull requests принимаются
- Обратная связь важна для развития

---

**☕ Key Bar** — современное решение для ресторанного бизнеса! 🎉
